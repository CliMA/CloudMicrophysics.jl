<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Developer&#39;s Guide · CloudMicrophysics.jl</title><meta name="title" content="Developer&#39;s Guide · CloudMicrophysics.jl"/><meta property="og:title" content="Developer&#39;s Guide · CloudMicrophysics.jl"/><meta property="twitter:title" content="Developer&#39;s Guide · CloudMicrophysics.jl"/><meta name="description" content="Documentation for CloudMicrophysics.jl."/><meta property="og:description" content="Documentation for CloudMicrophysics.jl."/><meta property="twitter:description" content="Documentation for CloudMicrophysics.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="CloudMicrophysics.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">CloudMicrophysics.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">Parameterizations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../Microphysics0M/">0-moment precipitation microphysics</a></li><li><a class="tocitem" href="../Microphysics1M/">1-moment precipitation microphysics</a></li><li><a class="tocitem" href="../Microphysics2M/">2-moment precipitation microphysics</a></li><li><a class="tocitem" href="../P3Scheme/">P3 Scheme</a></li><li><a class="tocitem" href="../MicrophysicsNonEq/">Non-equilibrium cloud formation</a></li><li><a class="tocitem" href="../ThresholdsTransition/">Smooth transition at thresholds</a></li><li><a class="tocitem" href="../AerosolActivation/">Aerosol activation</a></li><li><a class="tocitem" href="../WaterActivity/">Water Activity</a></li><li><a class="tocitem" href="../IceNucleation/">Ice Nucleation</a></li><li><a class="tocitem" href="../AerosolNucleation/">Aerosol Nucleation</a></li><li><a class="tocitem" href="../PrecipitationSusceptibility/">Precipitation Susceptibility</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">How to guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../guides/literated/GettingStarted/">Getting started</a></li><li><a class="tocitem" href="../guides/literated/Parameters/">Handling parameters</a></li><li><a class="tocitem" href="../guides/literated/SimpleModel/">Building a model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Models</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../IceNucleationParcel0D/">Adiabatic parcel model</a></li><li><a class="tocitem" href="../IceNucleationBox0D/">Box Model</a></li></ul></li><li><a class="tocitem" href="../API/">API</a></li><li class="is-active"><a class="tocitem" href>Developer&#39;s Guide</a><ul class="internal"><li><a class="tocitem" href="#GitHub-workflow"><span>GitHub workflow</span></a></li><li><a class="tocitem" href="#New-contributions"><span>New contributions</span></a></li><li><a class="tocitem" href="#Documentation"><span>Documentation</span></a></li><li><a class="tocitem" href="#Tests"><span>Tests</span></a></li></ul></li><li><a class="tocitem" href="../Glossary/">Glossary</a></li><li><a class="tocitem" href="../References/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Developer&#39;s Guide</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Developer&#39;s Guide</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/CloudMicrophysics.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/CloudMicrophysics.jl/blob/main/docs/src/DevelopersGuide.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Developer&#39;s-Guide"><a class="docs-heading-anchor" href="#Developer&#39;s-Guide">Developer&#39;s Guide</a><a id="Developer&#39;s-Guide-1"></a><a class="docs-heading-anchor-permalink" href="#Developer&#39;s-Guide" title="Permalink"></a></h1><p>This doc is meant to guide any beginner developers with organization   and common surprises associated with contributing to <code>CloudMicrophysics.jl</code>.</p><h2 id="GitHub-workflow"><a class="docs-heading-anchor" href="#GitHub-workflow">GitHub workflow</a><a id="GitHub-workflow-1"></a><a class="docs-heading-anchor-permalink" href="#GitHub-workflow" title="Permalink"></a></h2><p>We work on branches of the main repository, rather than personal forks. Each branch name should ideally start with your initials, followed by short   name relevant to what will be added in that branch. It is considered a good practice to open an issue that describes the planned work   before starting the implementation. This allows you to get feedback from other developers and advertise the planned work to the group. When the implemented code is ready for review, create a pull request (PR) on GitHub   and tag the issue it is addressing. In the PR you can describe which parts of the relevant issue are solved and what needs to   be done to reach that goal. After creating a PR on GitHub, you will find that every following commit &amp; push you make   will go through continuous integration (CI) checks:</p><ul><li>The, <code>ci</code> runs the tests on Ubuntu, Windows and OSX machines using GitHub Actions. The tests include some unit tests and very simple performance tests. It may happen that the tests pass on your local machine, but fail on one of the machines provided in the cloud for the CI. This is especially true for the performance tests, as the execution times may vary a lot depending on the machine. The CI is the source of truth over local tests, and all tests must pass in the CI before code can be merged. See the <a href="https://clima.github.io/CloudMicrophysics.jl/dev/DevelopersGuide/#Tests">Tests</a> section below for debugging tips.</li><li><code>CloudMicrophysics.jl</code> has a small set of tests that are run on the GPUs using <code>buildkite</code>. They are triggered automatically when trying to merge a PR. If the GPU tests fail, check first for use of any &quot;out of place&quot; functions (for example, <code>@warn</code> will not work on GPU).</li><li>The <code>Documentation / docbuild</code> builds the documentation. Most common errors in the docbuild are related to missing docstrings, see the <a href="https://clima.github.io/CloudMicrophysics.jl/dev/DevelopersGuide/#Documentation">Documentation</a> section for hints. This check may fail if the source code itself is not compiling, so please handle the compilation errors first. If the documentation build was successful, the <code>documenter/deploy</code> will display the documentation page based on the PR (click on the details).</li><li>The <code>JuliaFormatter / format</code> ensures consistent formatting throughout the repository. If this check fails, you can click on details to see which files are not following the formatting rules. You can apply the formatter by running <code>julia --project=.dev .dev/climaformat.jl file_name</code> in the terminal. The formatter might break if the code does not compile, so make sure you handle the compilation errors first.</li><li>The <code>codecov</code> shows what percentage of source code lines are exercised inside the tests. We strive to keep the test coverage high, but this test is not strictly required to pass before merging a PR.</li></ul><p>Once the PR is opened, you can request reviewers to look over and approve your work. To keep things tidy, we want PRs to have few (ideally only one) commit   before merging to the main branch. You can squash and rebase multiple commits into one   in your favorite editor (VS Code, Vim etc). In case of doubt, see Git tutorials on how to squash and rebase   or reach out to other developers in our team. The first couple of times it pays off to create a &quot;backup branch&quot; before starting your rebase,   and then comparing afterwards if the rebased and backup branches are identical. If the main branch has been updated after your branch was created, you will need to rebase onto the main branch. To do this, run git rebase origin/main and solve any conflicts manually. This is done more easily if you only have one commit. You can merge the PR if all the tests are passing   and the PR branch is up to date with the main branch.</p><p>The easiest way to use the new additions in the <code>main</code> branch of <code>CloudMicrophysics.jl</code>   from another package is to do a package release. To do that, you need to change the package version in the <code>Project.toml</code>. We do a patch release if the API did not change (for example <code>0.11.1 -&gt; 0.11.2</code>)   and a minor version release if it did (for example <code>0.11.1 -&gt; 0.12.0</code>). We use the <code>JuliaRegistrator</code> bot to register new versions in the <code>Julia</code> package ecosystem,   by commenting <code>@JuliaRegistrator register</code> under the merged PR that changes the package version. You can also use specific branches from the repository,   if you are working with commits that were not yet merged into <code>main</code>. See <a href="https://pkgdocs.julialang.org/v1/managing-packages/#Adding-registered-packages">Pkg.jl docs</a>   for more details.</p><h2 id="New-contributions"><a class="docs-heading-anchor" href="#New-contributions">New contributions</a><a id="New-contributions-1"></a><a class="docs-heading-anchor-permalink" href="#New-contributions" title="Permalink"></a></h2><p><code>CloudMicrophysics.jl</code> is a collection of point-wise functions grouped   in different modules depending on which aspect of aerosol and cloud microphysics   they address. When adding a new function, decide if a new module is required, or add to the existing one. If the added function will be used in other modules, export the function. Avoid exporting functions that are only used within the module it is defined in   or functions that have the same name as a function already in the API. Avoid shortening words or phrases when naming new functions. The name of the function should be self-explanatory yet brief. All functions should have docstrings describing the API, as well as   documentation focusing on the scientific aspects of what they do. All functions should have their own unit, performance and GPU tests. All free parameters should be stored in <a href="https://github.com/CliMA/CLIMAParameters.jl">CLIMAParameters</a>. It is usually faster to prototype defining the free parameters locally,   and move them to <code>CLIMAParameters</code> at a last step.</p><p>Other files that may require editing after you make a new function are:</p><ul><li><code>CloudMicrophysics.jl</code> (found in <code>src</code> folder) if you need to include a new source file,</li><li><code>index.md</code> (found in <code>docs/src</code> folder) if you want to mention the new additions in the main documentation page,</li><li><code>make.jl</code> (found in <code>docs</code> folder) if you are adding a new file to the documentation,</li><li><code>API.md</code> (found in <code>docs/src</code> folder) if you are adding functions (see <span>$Documentation$</span> section for more details),</li><li><code>runtests.jl</code> (found in <code>test</code> folder) if you are adding new test file for unit tests.</li></ul><h2 id="Documentation"><a class="docs-heading-anchor" href="#Documentation">Documentation</a><a id="Documentation-1"></a><a class="docs-heading-anchor-permalink" href="#Documentation" title="Permalink"></a></h2><p>Each new addition to the library should be accompanied by a documentation page   summarizing the derivation/assumptions and it&#39;s potential uses. If possible, it&#39;s really appreciated to also add short code snippets that reproduce   results from the literature. Those code snippets are executed every time documentation is build and provide   great examples on how different available parameterizations work.</p><p>Additionally, each function in the source code is required to have a docstring   and should be added to the <code>API</code> documentation page. The docstring formatting is pretty strict:   (i) no empty lines between the docstring and the function/module,   (ii) docstring starts and ends with a line consisting of three quotation marks,   (iii) the second line has the function&#39;s name preceded by exactly 4 spaces. Examples can be found in the source files. Be sure to add the function to <code>API.md</code> in the docs folder. Missing docstrings and functions in the API cause the documentation build to break.</p><p>To build and work the documentation locally, you can use <a href="https://github.com/tlienart/LiveServer.jl#serve-docs">LiveServer.jl</a>. This will compile the documentation to a local server that is updated whenever you make changes. Alternatively, you can save the documentation to a static webpage: <code>julia --project=docs docs/make.jl</code>. The index page will be saved in <code>docs/build</code> folder.</p><h2 id="Tests"><a class="docs-heading-anchor" href="#Tests">Tests</a><a id="Tests-1"></a><a class="docs-heading-anchor-permalink" href="#Tests" title="Permalink"></a></h2><h3 id="Unit-Tests"><a class="docs-heading-anchor" href="#Unit-Tests">Unit Tests</a><a id="Unit-Tests-1"></a><a class="docs-heading-anchor-permalink" href="#Unit-Tests" title="Permalink"></a></h3><p>Unit tests aim to ensure that parameterizations make physical sense. They can be found in the <code>test</code> folder under files named after corresponding source files. If you create a new function, please also create a new test that checks it. If creating a new file for unit tests, make sure you import <code>Test</code> and any other necessary libraries. There is some boilerplate code needed to create the sets with free parameters   based on the default <code>toml</code> file from <a href="https://github.com/CliMA/CLIMAParameters.jl">CLIMAParameters</a>.</p><p>Some possible tests include checking if the returned values agree with values   in the literature, if something is smaller/greater at warmer/cooler   temperatures, if assertion errors are returned when a function is used outside its   valid range of parameters, or if a function is zero at certain input values. In general, writing good tests is difficult and we are always on the lookout for new good candidates. We strive to exercise all functions in some way in tests,   so that at minimum we can catch changes in the API.</p><p>You can run the tests locally: <code>julia --project=test test/runtests.jl</code>.</p><h3 id="Performance-Tests"><a class="docs-heading-anchor" href="#Performance-Tests">Performance Tests</a><a id="Performance-Tests-1"></a><a class="docs-heading-anchor-permalink" href="#Performance-Tests" title="Permalink"></a></h3><p>Performance tests check the memory allocations (there should be none) and execution times   of some of the functions. They are found in the <code>test</code> folder under a single file named <code>performance_tests.jl</code>.</p><p>You can add performance tests for your new functions in the <code>benchmark_test(FT)</code> function. Parameters are listed at the start of the function. Next, add your performance tests under the comment with the file name which your   new function is in. This is done by calling <code>bench_press(function_name, (Parameter1, Parameter2), min_time)</code>. The last argument is an estimate of the minimum run-time of the function. It may take some trial and error to find a number   that will satisfy the <code>ci</code> tests that are run on different operating systems   and for different floating-point precision. You can identify which specific performance test is failing on GitHub   by clicking on details next to a failed check from one of the <code>ci / ci 1.8.1</code> checks. Adjust the estimated minimum run-time appropriately.</p><h3 id="GPU-Tests"><a class="docs-heading-anchor" href="#GPU-Tests">GPU Tests</a><a id="GPU-Tests-1"></a><a class="docs-heading-anchor-permalink" href="#GPU-Tests" title="Permalink"></a></h3><p>Graphic Processing Unit (GPU) tests check that <code>CloudMicrophysics.jl</code> functions are able to run on GPU. They are as simple as checking that a certain input returns a known value. Right now, we do not test the whole library on the GPUs,   so the support is limited. GPU tests can be found in the <code>test</code> folder under a single file named <code>gpu_tests.jl</code>. There are two things to add: a kernel for your function and the actual test.</p><p>Kernels are added at the top half of the file using <code>@kernel</code>. The naming convention follows <code>test_&lt;function name&gt;_kernel!</code>. Within the kernel, use <code>@inbounds</code> to place any outputs into an output array.</p><p>The test itself should be added in the <code>test_gpu(FT)</code> function. The test starts with defining <code>data_length</code> and ends after an <code>@test</code> macro. <code>data_length</code> corresponds to the number of outputs your function has. Add an array for each input required by your function. For example, if you want to test at temperature of 230K,   you can add <code>T = ArrayType([FT(230)])</code>. Add a comment of what you are testing and use <code>@test</code> to create your test. The GPU tests are ran twice: for <code>Float64</code> and <code>Float32</code>. Similar as with performance tests, some trial and error is needed   to find good tolerances for both options.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../API/">« API</a><a class="docs-footer-nextpage" href="../Glossary/">Glossary »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Wednesday 28 February 2024 22:12">Wednesday 28 February 2024</span>. Using Julia version 1.10.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
